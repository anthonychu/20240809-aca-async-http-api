<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Async HTTP API demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body style="margin: 48px 0px">
    <div class="container">
        <div id="buttonDiv">
            <button type="button" class="btn btn-primary">Place order</button>
        </div>
        <div id="messages" style="white-space: pre;"></div>
        <div class="card" id="orderCard" style="display: none;">
            <div class="card-body">
              <h5 class="card-title">Order completed!</h5>
              <div id="order" style="white-space: pre;""></div>
            </div>
          </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script type="module">
        const messagesDiv = document.querySelector('#messages')

        document.querySelector('button').addEventListener('click', async () => {
            document.querySelector('#buttonDiv').style.display = 'none'

            const logger = (message) => {
                messagesDiv.innerHTML += message
            }

            const order = await placeOrderAndWait({
                "customer": "Contoso",
                "items": [
                    {
                        "name": "Apple",
                        "quantity": 5
                    },
                    {
                        "name": "Banana",
                        "quantity": 3
                    },
                ],
            }, logger)

            if (!order) {
                return
            }

            document.querySelector('#order').innerHTML = JSON.stringify(order, null, 2)
            document.querySelector('#orderCard').style.display = 'block'
            messagesDiv.style.display = 'none'
        })

        async function placeOrderAndWait(order, logger) {
            const response = await fetch('/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(order)
            })
            
            if (response.status !== 202) {
                logger(`Something went wrong\nResponse: ${await response.text()}\n`)
                return
            }
            
            const responseOrigin = new URL(response.url).origin
            let statusLocation = response.headers.get('Location')
            // if the Location header is not an absolute URL, construct it
            statusLocation = new URL(statusLocation, responseOrigin).href

            logger("Order accepted, waiting for completion...\n")
            logger(`Status location: ${statusLocation}\n`)

            while (true) {
                const response = await fetch(statusLocation, {
                    redirect: 'follow'
                })
                const data = await response.json()

                if (response.status !== 200 && !response.redirected) {
                    logger(`Something went wrong\nResponse: ${JSON.stringify(data, null, 2)}\n`)
                    return
                }

                if (response.redirected) {
                    logger(`Order completed\n`)
                    return data
                }

                const retryAfter = parseInt(response.headers.get('Retry-After')) || 10
                logger(`Order status: ${data.status}; retrying in ${retryAfter} seconds\n`)

                await new Promise(resolve => setTimeout(resolve, retryAfter * 1000))
            }
        }

    </script>
</body>

</html>